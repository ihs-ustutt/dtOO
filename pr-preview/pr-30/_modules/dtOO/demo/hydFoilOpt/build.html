

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dtOO.demo.hydFoilOpt.build &mdash; dtOO  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html">
            
              <img src="../../../../_static/dtoo-logo-inv-nbg.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../demonstration.html">Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../test.html">Test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ihs-ustutt/dtOO">Back to GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">dtOO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dtOO.demo.hydFoilOpt.build</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dtOO.demo.hydFoilOpt.build</h1><div class="highlight"><pre>
<span></span><span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#  dtOO &lt; design tool Object-Oriented &gt;</span>
<span class="c1">#    </span>
<span class="c1">#    Copyright (C) 2024 A. Tismer.</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#License</span>
<span class="c1">#    This file is part of dtOO.</span>
<span class="c1">#</span>
<span class="c1">#    dtOO is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">#    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="c1">#    FITNESS FOR A PARTICULAR PURPOSE.  See the LICENSE.txt file in the</span>
<span class="c1">#    dtOO root directory for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the License along with dtOO.</span>
<span class="c1">#</span>
<span class="c1">#------------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This example optimizes a hydrofoil that is defined with 3 Degrees Of Freedom </span>
<span class="sd">(DOFs). The optimization is performed with the differential evolution </span>
<span class="sd">algorithm of `scipy`.</span>

<span class="sd">The fastest way to run the optimization of the hydrofoil is to execute:</span>

<span class="sd">.. code-block:: bash</span>
<span class="sd">  </span>
<span class="sd">  pip install foamlib \</span>
<span class="sd">    &amp;&amp; export OSLO_LOCK_PATH=/tmp \</span>
<span class="sd">    &amp;&amp; export FOAM_SIGFPE=0 \</span>
<span class="sd">    &amp;&amp; python3.12 -m doctest build.py</span>

<span class="sd">Within the command `foamlib` is installed that is necessary to control </span>
<span class="sd">OpenFoam in Python. The variable `OSLO_LOCK_PATH` defines the lock directory </span>
<span class="sd">for `oslo.concurrency`. This should be a directory with fast I/O access. The </span>
<span class="sd">second variable `FOAM_SIGFPE` is optional, but might be useful for preventing</span>
<span class="sd">OpenFoam to fail with a floating point exception. Finally, this script is</span>
<span class="sd">executed using the `doctest` module of Python.</span>

<span class="sd">The optimizer is imported from scipy and the interested reader is referred to</span>
<span class="sd">`[SciPy_2025] \</span>
<span class="sd">&lt;https://docs.scipy.org/doc/scipy/reference/generated/\</span>
<span class="sd">scipy.optimize.differential_evolution.html#\</span>
<span class="sd">scipy.optimize.differential_evolution&gt;`_</span>

<span class="sd">&gt;&gt;&gt; from scipy.optimize import differential_evolution</span>

<span class="sd">The callback function `optimizeHydFoil` of the optimizer executes all steps</span>
<span class="sd">of the hydrofoil case. In the end, the fitness value of the hydrofoil is set</span>
<span class="sd">as return value of the callback. Additionally, an exception handling catches</span>
<span class="sd">all exceptions and returns a defined fitness value in case of an error.</span>

<span class="sd">&gt;&gt;&gt; def optimizeHydFoil(x):</span>
<span class="sd">...   try:</span>
<span class="sd">...     hf = hydFoil( alpha_1=x[0], alpha_2=x[1], t_mid=x[2] )</span>
<span class="sd">...     hf.Geometry()</span>
<span class="sd">...     hf.GeometryMesh()</span>
<span class="sd">...     hf.Mesh()</span>
<span class="sd">...     hf.Simulate()</span>
<span class="sd">...     fit = hf.Evaluate()</span>
<span class="sd">...   except:</span>
<span class="sd">...     logging.warning(&quot;Catch Exception&quot;)</span>
<span class="sd">...     fit = hydFoil.FailedFitness() </span>
<span class="sd">...   return fit</span>

<span class="sd">Define the bounds of the DOFs for the optimization.</span>

<span class="sd">&gt;&gt;&gt; bounds = [(150.0, 170.0), (155.0, 175.0), (0.01, 0.10),]</span>

<span class="sd">Call the optimizer with the callback function. The number of candidates is</span>
<span class="sd">low to have a fast code example.</span>

<span class="sd">&gt;&gt;&gt; result = differential_evolution(</span>
<span class="sd">...   optimizeHydFoil, </span>
<span class="sd">...   bounds, </span>
<span class="sd">...   popsize=3, </span>
<span class="sd">...   maxiter=2,</span>
<span class="sd">...   polish=False</span>
<span class="sd">... )</span>

<span class="sd">Output the final result of the optimization.</span>

<span class="sd">&gt;&gt;&gt; logging.info( </span>
<span class="sd">...   &quot;Optimum found at (alpha_1, alpha_2, t_mid) = (%f, %f, %f) with %f&quot;</span>
<span class="sd">...   %</span>
<span class="sd">...   ( result.x[0], result.x[1], result.x[2], result.fun )</span>
<span class="sd">... )</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#</span>
<span class="c1"># Create a logging object</span>
<span class="c1">#</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
  <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[ </span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)8s</span><span class="s1"> - </span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1"> ]&#39;</span>
         <span class="s1">&#39; - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> 
  <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">,</span> 
  <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Import packages</span>
<span class="c1">#</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dtOOPythonSWIG</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dtOO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">foamlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

<span class="c1">#</span>
<span class="c1"># Define the values that will be stored during the optimization; here only the</span>
<span class="c1"># name and the initial definition for each stored value is declared; the</span>
<span class="c1"># arrays objective and fitness are created by default</span>
<span class="c1">#</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyDtOO</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">dtClusteredSingletonState</span><span class="o">.</span><span class="n">ADDDATA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dH&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">,]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">dtClusteredSingletonState</span><span class="o">.</span><span class="n">ADDDATADEF</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">,],</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">,],</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span><span class="p">,],</span>
<span class="p">]</span>

<div class="viewcode-block" id="hydFoil">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">hydFoil</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Create, mesh, simulate and evaluate a hydrofoil.</span>

<span class="sd">  This class holds all functions to create a hydrofoil with an inlet angle,</span>
<span class="sd">  outlet angle and a blade thickness. :numref:`hydfoil` shows a sketch of the </span>
<span class="sd">  hydrofoil.</span>

<span class="sd">  .. _hydfoil:</span>
<span class="sd">  .. figure:: img/hydfoil.png</span>
<span class="sd">     :width: 600</span>
<span class="sd">     :align: center</span>

<span class="sd">     Hydrofoil&#39;s sketch including mean line (solid thick black line) and final</span>
<span class="sd">     shape (solid thin black line); B-Splines, that are used for constructing</span>
<span class="sd">     the meanline and final shape, are shown as solid and dashed gray thin</span>
<span class="sd">     lines; velocity triangles at inlet and outlet of the hydrofoil are </span>
<span class="sd">     colored in magenta; the DOFs, namely :math:`\\alpha_1`,</span>
<span class="sd">     :math:`\\alpha_2`, and :math:`t_{mid}`, are shown and labeled in black</span>

<span class="sd">  The simulation of the hydrofoil is performed in the relational frame of</span>
<span class="sd">  reference. It means that all velocities in the CFD simulation correspond to</span>
<span class="sd">  :math:`w`. Therefore, when evaluating hydrofoil&#39;s efficiency and head, the</span>
<span class="sd">  transformation</span>

<span class="sd">  .. math::</span>

<span class="sd">    c = w + u = w + 2 \\pi n R \\approx w + 18.84 \\frac{m}{s}</span>
<span class="sd">  </span>
<span class="sd">  is necessary to get the absolute velocity :math:`c`. The hydrofoil is </span>
<span class="sd">  designed for a design head of :math:`0.8 m`. The fitness function is </span>
<span class="sd">  calculated based on head deviation and efficiency.</span>

<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  alpha_1: float</span>
<span class="sd">    Inlet angle.</span>
<span class="sd">  alpha_2: float</span>
<span class="sd">    Outlet angle.</span>
<span class="sd">  t_mid: float</span>
<span class="sd">    Blade&#39;s thickness.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
  
  <span class="n">H_</span>          <span class="o">=</span> <span class="mf">0.2</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Height of the mesh in :math:`m`.&quot;&quot;&quot;</span>
  <span class="n">R_</span>          <span class="o">=</span> <span class="mf">2.0</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Radius of the blade cut in :math:`m` where this hydrofoil is </span>
<span class="sd">            located.&quot;&quot;&quot;</span>
  <span class="n">nB_</span>         <span class="o">=</span> <span class="mi">4</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Number of blades in which this hydrofoil is located.&quot;&quot;&quot;</span>
  <span class="n">L_</span>          <span class="o">=</span> <span class="mf">4.0</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Length of the mesh in :math:`m`.&quot;&quot;&quot;</span>
  <span class="n">n_</span>          <span class="o">=</span> <span class="mf">90.0</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Rotational speed in :math:`min^{-1}`.&quot;&quot;&quot;</span>
  <span class="n">c_mi_</span>       <span class="o">=</span> <span class="mf">5.77</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;float: Absolute velocity at inlet in :math:`\\frac{m}{s}`&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">alpha_1</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>  
    <span class="n">alpha_2</span> <span class="o">=</span> <span class="mi">130</span><span class="p">,</span> 
    <span class="n">t_mid</span> <span class="o">=</span> <span class="mf">0.1</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtClusteredSingletonState</span><span class="p">(</span>
      <span class="n">defObj</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha_1</span><span class="p">,</span> <span class="n">alpha_2</span><span class="p">,</span> <span class="n">t_mid</span><span class="p">],</span>
      <span class="n">defFit</span> <span class="o">=</span> <span class="p">[</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">FailedFitness</span><span class="p">(),]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">state</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;str: State label.&quot;&quot;&quot;</span>

    <span class="n">dtOO</span><span class="o">.</span><span class="n">logMe</span><span class="o">.</span><span class="n">initLog</span><span class="p">(</span><span class="s1">&#39;build.&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">state_</span><span class="o">+</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>
    
    <span class="n">dtOO</span><span class="o">.</span><span class="n">staticPropertiesHandler</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
        <span class="s1">&#39;{&#39;</span>
          <span class="s1">&#39;&quot;option&quot; : [&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;reparamOnFace_precision&quot;, &quot;value&quot; : &quot;1.e-06&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;reparamInVolume_precision&quot;,&quot;value&quot; : &quot;1.e-06&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;reparam_internalRestarts&quot;, &quot;value&quot; : &quot;10&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;reparam_restarts&quot;, &quot;value&quot; : &quot;10&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;reparam_restartIncreasePrecision&quot;, &quot;value&quot; : &quot;10.&quot;},&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;reparam_internalRestartDecreasePrecision&quot;,&#39;</span>
              <span class="s1">&#39; &quot;value&quot; : &quot;0.9&quot;&#39;</span>
            <span class="s1">&#39;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;invY_precision&quot;, &quot;value&quot; : &quot;1.e-04&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;xyz_resolution&quot;, &quot;value&quot; : &quot;1.e-08&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;XYZ_resolution&quot;, &quot;value&quot; : &quot;1.e-07&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;uvw_resolution&quot;, &quot;value&quot; : &quot;1.e-04&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;root_printLevel&quot;, &quot;value&quot; : &quot;0&quot;},&#39;</span>		
            <span class="s1">&#39;{&quot;name&quot; : &quot;root_maxIterations&quot;, &quot;value&quot; : &quot;1000&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;root_maxFunctionCalls&quot;, &quot;value&quot; : &quot;1000000&quot;},&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;logLevel&quot;, &quot;value&quot; : &quot;99&quot;}&#39;</span>
          <span class="s1">&#39;]&#39;</span>
        <span class="s1">&#39;}&#39;</span>
      <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtBundle</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.dtBundle: Bundle object.&quot;&quot;&quot;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">bC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_bC</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.baseContainer: base container.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_cV</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingConstValue: Container object </span>
<span class="sd">    of dtOOPythonSWIG.constValue.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_aF</span><span class="p">()</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingAnalyticFunction: Container object </span>
<span class="sd">    of dtOOPythonSWIG.analyticFunction.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_aG</span><span class="p">()</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingAnalyticGeometry: Container object </span>
<span class="sd">    of dtOOPythonSWIG.analyticGeometry.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_bV</span><span class="p">()</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingBoundedVolume: Container object </span>
<span class="sd">    of dtOOPythonSWIG.boundedVolume.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_dC</span><span class="p">()</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingDtCase: Container object </span>
<span class="sd">    of dtOOPythonSWIG.dtCase.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">cptr_dP</span><span class="p">()</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dtOOPythonSWIG.labeledVectorHandlingDtPlugin: Container object </span>
<span class="sd">    of dtOOPythonSWIG.dtPlugin.&quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Create and initialize constValues for DOFs; the objects are cloned and</span>
    <span class="c1"># appended to the container; it is necessary to create a clone, otherwise</span>
    <span class="c1"># the instance is destructed at the end of this function; it is also </span>
    <span class="c1"># possible to use the thisown flag that is implemented via SWIG, see</span>
    <span class="c1"># documentation of SWIG </span>
    <span class="c1"># https://www.swig.org/Doc4.1/SWIGDocumentation.html#Python_nn28</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">sliderFloatParam</span><span class="p">(</span><span class="s2">&quot;alpha_1&quot;</span><span class="p">,</span> <span class="n">alpha_1</span><span class="p">,</span> <span class="mf">130.0</span><span class="p">,</span> <span class="mf">170.0</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">sliderFloatParam</span><span class="p">(</span><span class="s2">&quot;alpha_2&quot;</span><span class="p">,</span> <span class="n">alpha_2</span><span class="p">,</span> <span class="mf">130.0</span><span class="p">,</span> <span class="mf">170.0</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">sliderFloatParam</span><span class="p">(</span><span class="s2">&quot;t_mid&quot;</span><span class="p">,</span> <span class="n">t_mid</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Add a lVHOstateHandler object to create state labels; clearing is </span>
    <span class="c1"># necessary to prevent memory corruption; thisown is necessary to make</span>
    <span class="c1"># sure that object is not destructed at the end of this function</span>
    <span class="c1">#</span>
    <span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="p">(</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cV</span> <span class="p">)</span><span class="o">.</span><span class="n">thisown</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#</span>
    <span class="c1"># Create a state using the lVHOstateHandler; this forces also the creation</span>
    <span class="c1"># of a json file &lt;statename&gt;.json written to disk</span>
    <span class="c1">#</span>
    <span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="p">()</span><span class="o">.</span><span class="n">makeState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_</span><span class="p">)</span>


<div class="viewcode-block" id="hydFoil.Geometry">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.Geometry">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create hydrofoil&#39;s geometry.</span>
<span class="sd">  </span>
<span class="sd">    The main objects of baseContainer, analyticFunction, and analyticGeometry</span>
<span class="sd">    are created. Objects that are necessary or interesting are appended to the</span>
<span class="sd">    :attr:`hydFoilOpt.build.hydFoil.bV`, :attr:`hydFoilOpt.build.hydFoil.aF`, </span>
<span class="sd">    and :attr:`hydFoilOpt.build.hydFoil.aG`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
   
    <span class="c1">#</span>
    <span class="c1"># Calculate the width of the channel; it is given by the fraction of the </span>
    <span class="c1"># unwounded length </span>
    <span class="c1"># </span>
    <span class="n">twoPiRByNB</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span><span class="o">/</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">nB_</span>
    
    <span class="c1">#</span>
    <span class="c1"># Create 4 points to define the periodic surface located on the left side;</span>
    <span class="c1"># points are objects of dtPoint3; coordinates are accessible using python&#39;s</span>
    <span class="c1"># index notation ([]-operator)</span>
    <span class="c1">#</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint3</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">H_</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">twoPiRByNB</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint3</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hydFoil</span><span class="o">.</span><span class="n">L_</span><span class="p">)</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint3</span><span class="p">(</span><span class="n">P1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">H_</span><span class="p">,</span> <span class="n">P1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">P1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint3</span><span class="p">(</span><span class="n">P2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">H_</span><span class="p">,</span> <span class="n">P2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">P2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create B-Spline surface by skinning two B-Spline lines; the lines are</span>
    <span class="c1"># straight connections, because order is not specified; therefore default</span>
    <span class="c1"># value of 1 is used</span>
    <span class="c1">#</span>
    <span class="n">perio</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">analyticSurface</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">bSplineSurface_skinConstructOCC</span><span class="p">(</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">bSplineCurve_pointConstructOCC</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">bSplineCurve_pointConstructOCC</span><span class="p">(</span><span class="n">P3</span><span class="p">,</span> <span class="n">P4</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
      <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create channel volume by translating B-Spline surface in y-direction</span>
    <span class="c1">#</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">translatingMap2dTo3d</span><span class="p">(</span>
     <span class="n">dtOO</span><span class="o">.</span><span class="n">dtVector3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">twoPiRByNB</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">perio</span>
    <span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Define label for the channel volume</span>
    <span class="c1">#</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Append a clone of the channel volume to the analyticGeometry container;</span>
    <span class="c1"># as an alternative without cloning, the thisown flag of channel volume</span>
    <span class="c1"># must be set to 0</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create a conformal mapping to map between parameter and physical </span>
    <span class="c1"># coordinates; the transformer is initialized with a JSON object that</span>
    <span class="c1"># defines the label, the geometry &quot;to-map-to&quot;, the number of points in</span>
    <span class="c1"># v-direction, and the number of points in w-direction; it is necessary</span>
    <span class="c1"># to give self.aG as input argument, because the transformer clones the</span>
    <span class="c1"># geometry &quot;to-map-to&quot; and keeps an instance as an attribute; therefore, a</span>
    <span class="c1"># geometry change of &quot;xyz_channel&quot; after the next statement is useless</span>
    <span class="c1"># for the transformer; the internal &quot;to-map-to&quot; geometry is not update;</span>
    <span class="c1"># store a clone in the analyticGeometry container, too</span>
    <span class="c1">#</span>
    <span class="n">cMap</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">uVw_deltaMs</span><span class="p">()</span>
    <span class="n">cMap</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">()</span>
        <span class="o">.</span><span class="n">appendStr</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;cMap&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">appendAnalyticGeometry</span><span class="p">(</span><span class="s2">&quot;_tM2d&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nV&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nW&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bC</span><span class="o">.</span><span class="n">ptrTransformerContainer</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">cMap</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Extract instances of constValue by their labels (&quot;alpha_1&quot; and </span>
    <span class="c1"># &quot;alpha_2&quot;); a call to the ()-operator on a constValue object, returns</span>
    <span class="c1"># its internal value</span>
    <span class="c1">#</span>
    <span class="n">alpha_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="p">[</span><span class="s2">&quot;alpha_1&quot;</span><span class="p">]()</span>
    <span class="n">alpha_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="p">[</span><span class="s2">&quot;alpha_2&quot;</span><span class="p">]()</span>

    <span class="c1">#</span>
    <span class="c1"># Define additional parameter variables and assign values; theoretically,</span>
    <span class="c1"># those variables could also be modifiable, but the example is kept as</span>
    <span class="c1"># small as possible; therefore those are fix</span>
    <span class="c1">#</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">deltaM</span> <span class="o">=</span> <span class="mf">0.30</span>
    <span class="n">offM</span>   <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">bladeLength</span> <span class="o">=</span> <span class="mf">0.70</span>
   
    <span class="c1">#</span>
    <span class="c1"># Import predefined builder to create a mean plane based on alphaOne,</span>
    <span class="c1"># alphaTwo, ratioX, deltaY, offX, offY and targetLength, see corresponding</span>
    <span class="c1"># documentation for details; the DOFs are prescribed as functions; in this</span>
    <span class="c1"># case, the functions are a linear curve between two points; the builder </span>
    <span class="c1"># gets and returns a dtBundle object; the generated mean plane is appended </span>
    <span class="c1"># to the input dtBundle object; all created objects are labeled with the </span>
    <span class="c1"># given tag; in the case at hand, it is simply &quot;meanplane&quot;</span>
    <span class="c1">#</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dtOOPythonApp.builder</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
      <span class="n">analyticSurface_threePointMeanplaneFromRatio</span><span class="p">,</span>
      <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">analyticSurface_threePointMeanplaneFromRatio</span><span class="p">(</span>
      <span class="s2">&quot;meanplane&quot;</span><span class="p">,</span>
      <span class="n">spanwiseCuts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">0.00</span><span class="p">,</span>  
        <span class="mf">1.00</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="n">alphaOne</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_1</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_1</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">alphaTwo</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_2</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_2</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">ratioX</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">ratio</span><span class="p">),</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">ratio</span><span class="p">),</span>  
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">deltaY</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">deltaM</span><span class="p">),</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">deltaM</span><span class="p">),</span>  
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">offX</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">twoPiRByNB</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">twoPiRByNB</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">offY</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">offM</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">offM</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">targetLength</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">bladeLength</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">bladeLength</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">targetLengthTolerance</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
      <span class="n">originOnLengthPercent</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="p">)</span><span class="o">.</span><span class="n">buildExtract</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># At first, extract the DOF &quot;t_mid&quot; for the thickness distribution out of</span>
    <span class="c1"># the container by its label; then, import and apply a predefined builder</span>
    <span class="c1"># for a B-Spline thickness distribution defined by 5 control points</span>
    <span class="c1">#</span>
    <span class="n">t_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cV</span><span class="p">[</span><span class="s2">&quot;t_mid&quot;</span><span class="p">]()</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dtOOPythonApp.builder</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
      <span class="n">vec3dSurfaceTwoD_fivePointsBSplineThicknessDistribution</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">vec3dSurfaceTwoD_fivePointsBSplineThicknessDistribution</span><span class="p">(</span>
      <span class="s2">&quot;thicknessDistribution&quot;</span><span class="p">,</span>
      <span class="n">spanwiseCuts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">0.00</span><span class="p">,</span>  
        <span class="mf">1.00</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="n">tLe</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">uLe</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">tMid</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">t_mid</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="n">t_mid</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">uMid</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">tTe</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)(),</span>
      <span class="n">uTe</span> <span class="o">=</span> <span class="n">scaOneD_scaCurve2dOneDPointConstruct</span><span class="p">(</span>
        <span class="p">[</span>
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">),</span>  
          <span class="n">dtOO</span><span class="o">.</span><span class="n">dtPoint2</span><span class="p">(</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="mi">1</span>
      <span class="p">)()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">buildExtract</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Define a transformer to combine the mean plane and the thickness</span>
    <span class="c1"># distribution; the transformer adds the thickness to the mean plane in</span>
    <span class="c1"># perpendicular direction; a number of predefined points in u- and </span>
    <span class="c1"># v-direction, respectively, &quot;_nU&quot; and &quot;_nV&quot;, are transformed to form</span>
    <span class="c1"># the final hydrofoil&#39;s shape; the points are resplined and, therefore,</span>
    <span class="c1"># connected by a B-Spline of order 3 (&quot;_order&quot;); as already explained the</span>
    <span class="c1"># transformer clones the &quot;thicknessDistribution&quot; to keep an internal</span>
    <span class="c1"># instance and, in that sense, it is necessary to have self.aF as an </span>
    <span class="c1"># inlet argument</span>
    <span class="c1">#</span>
    <span class="n">dAdd</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">discreteAddNormal</span><span class="p">()</span>
    <span class="n">dAdd</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
        <span class="s1">&#39;{&quot;option&quot; : [{&quot;name&quot; : &quot;debug&quot;, &quot;value&quot; : &quot;false&quot;}]}&#39;</span>
      <span class="p">)</span>
        <span class="o">.</span><span class="n">appendAnalyticFunction</span><span class="p">(</span><span class="s2">&quot;_tt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="s2">&quot;thicknessDistribution&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nU&quot;</span><span class="p">,</span> <span class="mi">61</span><span class="p">)</span>
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nV&quot;</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_order&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">.</span><span class="n">appendDtVector3</span><span class="p">(</span><span class="s2">&quot;_nf&quot;</span><span class="p">,</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtVector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Apply the defined transformer to the &quot;meanplane&quot; function; set a label</span>
    <span class="c1"># and append the object to the analyticFunction container</span>
    <span class="c1">#</span>
    <span class="n">theAF</span> <span class="o">=</span> <span class="n">dAdd</span><span class="o">.</span><span class="n">applyAnalyticFunction</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="s2">&quot;meanplane&quot;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">theAF</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;blade&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">theAF</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Perform the conformal mapping of the two dimensional B-Spline geometries</span>
    <span class="c1"># between parameter space (u,v) and physical space (x,y,z); the result is</span>
    <span class="c1"># a composition of multiple functions; append for each geometry a shape to</span>
    <span class="c1"># the analyticGeometry container</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meanplane&quot;</span><span class="p">,</span> <span class="s2">&quot;blade&quot;</span><span class="p">,]:</span>
      <span class="n">theAG</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dTwoDInMap3dTo3d</span><span class="p">(</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dTwoD</span><span class="o">.</span><span class="n">MustConstDownCast</span><span class="p">(</span>
          <span class="n">cMap</span><span class="o">.</span><span class="n">applyAnalyticFunction</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">ConstDownCast</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">)</span>
      <span class="n">theAG</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;xyz_&quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">theAG</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span></div>



<div class="viewcode-block" id="hydFoil.GeometryMesh">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.GeometryMesh">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">GeometryMesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create additional hydrofoil&#39;s geometry for meshing.</span>

<span class="sd">    Create additional objects that are necessary for creating the mesh. These</span>
<span class="sd">    are mainly object&#39;s of the mesh block that is created around the blade.</span>
<span class="sd">    This block is meshed as a structured block.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Create an analyticFunction that maps (u,v)-&gt;(t,u,v) with u, v, and t or</span>
    <span class="c1"># first parameter coordinate, second parameter coordinate, and thickness,</span>
    <span class="c1"># respectively; the thickness is fixed to 0.1; set the label and define</span>
    <span class="c1"># the bounds of first and second function argument</span>
    <span class="c1">#</span>
    <span class="n">fRef</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dMuParserTwoD</span><span class="p">(</span><span class="s2">&quot;0.10, uu, vv&quot;</span><span class="p">,</span> <span class="s2">&quot;uu&quot;</span><span class="p">,</span> <span class="s2">&quot;vv&quot;</span><span class="p">)</span>
    <span class="n">fRef</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;thicknessMeshBlock&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
      <span class="n">fRef</span><span class="o">.</span><span class="n">setMin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.0</span><span class="p">)</span>
      <span class="n">fRef</span><span class="o">.</span><span class="n">setMax</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create an temporary analyticFunction container to store the </span>
    <span class="c1"># analyticFunction; this is necessary to initialize the following</span>
    <span class="c1"># transformer; as an alternative the analyticFunction can also be appended</span>
    <span class="c1"># to :attr:`hydFoilOpt.build.hydFoil.aF`</span>
    <span class="c1">#</span>
    <span class="n">tmpAF</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">labeledVectorHandlingAnalyticFunction</span><span class="p">()</span>
    <span class="n">tmpAF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">fRef</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Define the transformer to create the outer boundary of the mesh</span>
    <span class="c1"># blocks; it is necessary to have a second transformer, because they</span>
    <span class="c1"># operate on different &quot;_tt&quot; attributes</span>
    <span class="c1">#</span>
    <span class="n">dAdd</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">discreteAddNormal</span><span class="p">()</span>
    <span class="n">dAdd</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
        <span class="s1">&#39;{&quot;option&quot; : [{&quot;name&quot; : &quot;debug&quot;, &quot;value&quot; : &quot;false&quot;}]}&#39;</span>
        <span class="p">)</span> \
        <span class="o">.</span><span class="n">appendAnalyticFunction</span><span class="p">(</span><span class="s2">&quot;_tt&quot;</span><span class="p">,</span> <span class="n">tmpAF</span><span class="p">[</span><span class="s2">&quot;thicknessMeshBlock&quot;</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nU&quot;</span><span class="p">,</span> <span class="mi">61</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_nV&quot;</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">appendInt</span><span class="p">(</span><span class="s2">&quot;_order&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">appendDtVector3</span><span class="p">(</span><span class="s2">&quot;_nf&quot;</span><span class="p">,</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtVector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tmpAF</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Apply transformer to blade geometry and append it to the corresponding</span>
    <span class="c1"># container</span>
    <span class="c1">#</span>
    <span class="n">theAF</span> <span class="o">=</span> <span class="n">dAdd</span><span class="o">.</span><span class="n">applyAnalyticFunction</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="s2">&quot;blade&quot;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">theAF</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;meshBlock&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">theAF</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Import predefined builder to create the mesh blocks; they are created by</span>
    <span class="c1"># skinning between the &quot;blade&quot; and &quot;meshBlock&quot; geometry in combination</span>
    <span class="c1"># with splitting the final three dimensional region; the resulting</span>
    <span class="c1"># geometries are appended to the dtBundle object</span>
    <span class="c1">#</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dtOOPythonApp.builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">vec3dThreeD_skinAndSplit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">vec3dThreeD_skinAndSplit</span><span class="p">(</span>
      <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;meshBlock&quot;</span><span class="p">,</span>
      <span class="n">aFOne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="s2">&quot;blade&quot;</span><span class="p">],</span>
      <span class="n">aFTwo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="s2">&quot;meshBlock&quot;</span><span class="p">],</span>
      <span class="n">splitDim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">],</span>
      <span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">buildExtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span>
  
    <span class="c1">#</span>
    <span class="c1"># Get a reference of the conformal mapping transformer</span>
    <span class="c1">#</span>
    <span class="n">cMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bC</span><span class="o">.</span><span class="n">ptrTransformerContainer</span><span class="p">()[</span><span class="s2">&quot;cMap&quot;</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># Perform the conformal mapping of the two dimensional B-Spline geometries</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meshBlock&quot;</span><span class="p">,]:</span>
      <span class="n">theAG</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dTwoDInMap3dTo3d</span><span class="p">(</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dTwoD</span><span class="o">.</span><span class="n">MustConstDownCast</span><span class="p">(</span>
          <span class="n">cMap</span><span class="o">.</span><span class="n">applyAnalyticFunction</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">ConstDownCast</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">)</span>
      <span class="n">theAG</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;xyz_&quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">theAG</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Perform the conformal mapping of the three dimensional B-Spline </span>
    <span class="c1"># geometries between parameter space (u,v,w) and (x,y,z)</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">iNum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(</span><span class="s2">&quot;meshBlock_*&quot;</span><span class="p">):</span>
      <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span> <span class="n">iNum</span> <span class="p">)</span>
      <span class="n">theAG</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dThreeDInMap3dTo3d</span><span class="p">(</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">vec3dThreeD</span><span class="o">.</span><span class="n">MustConstDownCast</span><span class="p">(</span>
          <span class="n">cMap</span><span class="o">.</span><span class="n">applyAnalyticFunction</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aF</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">ConstDownCast</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">)</span>
      <span class="n">theAG</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s2">&quot;xyz_&quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">theAG</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="p">)</span></div>


<div class="viewcode-block" id="hydFoil.Mesh">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.Mesh">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create hydrofoil&#39;s mesh.</span>

<span class="sd">    Create the topology for the hydrofoil&#39;s mesh. Additionally, define number</span>
<span class="sd">    of elements for edges and surfaces, define minimum and maximum element</span>
<span class="sd">    lengths for unstructured meshing algorithms, and label mesh parts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Extract coupling surfaces between mesh blocks and outer region; these</span>
    <span class="c1"># surfaces are necessary to define the outer region; in this simple test</span>
    <span class="c1"># case the surfaces of interest are clear, because the blocks are ordered;</span>
    <span class="c1"># store the blocks and surfaces in two lists &quot;blocks&quot; and &quot;couplingFaces&quot;</span>
    <span class="c1">#</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iNum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(</span><span class="s2">&quot;xyz_meshBlock_*&quot;</span><span class="p">):</span>
      <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span> <span class="n">iNum</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
    
    <span class="n">couplingFaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">couplingFaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
      <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">MustDownCast</span><span class="p">(</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">segmentConstUPercent</span><span class="p">(</span> <span class="mf">0.0</span> <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
      <span class="n">couplingFaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
        <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">MustDownCast</span><span class="p">(</span> <span class="n">block</span> <span class="p">)</span><span class="o">.</span><span class="n">segmentConstWPercent</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">)</span>
      <span class="p">)</span>
    <span class="n">couplingFaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> 
      <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">MustDownCast</span><span class="p">(</span> <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">segmentConstUPercent</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">)</span>
    <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create a boundedVolume object that keeps all geometries, topologies and</span>
    <span class="c1"># information for meshing; initialize the boundedVolume with a JSON </span>
    <span class="c1"># structure; gmsh options can be set as shown e.g. for the value</span>
    <span class="c1"># &quot;Mesh.CharacteristicLengthMin&quot;; theoretically, the geometries being</span>
    <span class="c1"># meshed can also be included in the JSON structure within the </span>
    <span class="c1"># vector of analyticGeometry; in the case at hand, they are added via</span>
    <span class="c1"># separate functions</span>
    <span class="c1">#</span>
    <span class="n">gBV</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">gmshBoundedVolume</span><span class="p">()</span>
    <span class="n">gBV</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
      <span class="s1">&#39;{&#39;</span>
        <span class="s1">&#39;&quot;label&quot; : &quot;mesh&quot;, &#39;</span>
        <span class="s1">&#39;&quot;option&quot; : [&#39;</span>
          <span class="s1">&#39;{&quot;name&quot; : &quot;[gmsh]General.Terminal&quot;, &quot;value&quot; : &quot;1.&quot;},&#39;</span>
          <span class="s1">&#39;{&quot;name&quot; : &quot;[gmsh]General.Verbosity&quot;, &quot;value&quot; : &quot;100.&quot;},&#39;</span>
          <span class="s1">&#39;{&quot;name&quot; : &quot;[gmsh]General.ExpertMode&quot;, &quot;value&quot; : &quot;1.&quot;},&#39;</span>
          <span class="s1">&#39;{&#39;</span>
            <span class="s1">&#39;&quot;name&quot; : &quot;[gmsh]Mesh.LcIntegrationPrecision&quot;, &#39;</span>
            <span class="s1">&#39;&quot;value&quot; : &quot;1.0E-04&quot;&#39;</span>
          <span class="s1">&#39;},&#39;</span>
          <span class="s1">&#39;{&#39;</span>
            <span class="s1">&#39;&quot;name&quot; : &quot;[gmsh]Mesh.CharacteristicLengthMin&quot;, &#39;</span>
            <span class="s1">&#39;&quot;value&quot; : &quot;0.1&quot;&#39;</span>
          <span class="s1">&#39;},&#39;</span>
          <span class="s1">&#39;{&#39;</span>
            <span class="s1">&#39;&quot;name&quot; : &quot;[gmsh]Mesh.CharacteristicLengthMax&quot;, &#39;</span>
            <span class="s1">&#39;&quot;value&quot; : &quot;0.5&quot;&#39;</span>
          <span class="s1">&#39;},&#39;</span>
          <span class="s1">&#39;{&quot;name&quot; : &quot;[gmsh]Mesh.Algorithm&quot;, &quot;value&quot; : &quot;1&quot;},&#39;</span>
          <span class="s1">&#39;{&#39;</span>
            <span class="s1">&#39;&quot;name&quot; : &quot;[gmsh]Mesh.MeshSizeExtendFromBoundary&quot;, &#39;</span>
            <span class="s1">&#39;&quot;value&quot; : &quot;1&quot;&#39;</span>
          <span class="s1">&#39;},&#39;</span>
          <span class="s1">&#39;{&quot;name&quot; : &quot;[gmsh]Mesh.MeshSizeFromPoints&quot;, &quot;value&quot; : &quot;1&quot;}&#39;</span>
        <span class="s1">&#39;],&#39;</span>
        <span class="s1">&#39;&quot;analyticGeometry&quot; : []&#39;</span>
      <span class="s1">&#39;}&#39;</span>
      <span class="p">),</span>
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Append the boundedVolume to its container; prevent destruction by</span>
    <span class="c1"># setting thisown to false</span>
    <span class="c1">#</span>
    <span class="n">gBV</span><span class="o">.</span><span class="n">thisown</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bV</span><span class="o">.</span><span class="n">set</span><span class="p">(</span> <span class="n">gBV</span> <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Store the underlying gmsh model in a separate variable to have easy</span>
    <span class="c1"># access</span>
    <span class="c1">#</span>
    <span class="n">gm</span> <span class="o">=</span> <span class="n">gBV</span><span class="o">.</span><span class="n">getModel</span><span class="p">()</span>
   
    <span class="c1">#</span>
    <span class="c1"># Add three dimensional outer region to model; the return value is the </span>
    <span class="c1"># internal tag of the region in the gmsh model; </span>
    <span class="c1">#</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">addIfRegionToGmshModel</span><span class="p">(</span> 
      <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">DownCast</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">]</span> <span class="p">)</span> 
    <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Add a physical tag to the region</span>
    <span class="c1">#</span>
    <span class="n">gm</span><span class="o">.</span><span class="n">tagPhysical</span><span class="p">(</span> <span class="n">gm</span><span class="o">.</span><span class="n">getRegionByTag</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="s2">&quot;xyz_channel&quot;</span> <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create a list that contains all indices of the mesh blocks; the list is</span>
    <span class="c1"># for easy access of the desired geometries</span>
    <span class="c1">#</span>
    <span class="n">mbIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(</span><span class="s2">&quot;xyz_meshBlock_*&quot;</span><span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Add the mesh block geometries to the gmsh model and, additionally, add</span>
    <span class="c1"># &quot;NORTH&quot; face of each block to the outer region; those faces are the</span>
    <span class="c1"># coupling faces</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">iNum</span> <span class="ow">in</span> <span class="n">mbIndices</span><span class="p">:</span>
      <span class="n">tag</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">addIfRegionToGmshModel</span><span class="p">(</span> 
        <span class="n">dtOO</span><span class="o">.</span><span class="n">map3dTo3d</span><span class="o">.</span><span class="n">DownCast</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="n">iNum</span><span class="p">]</span> <span class="p">)</span> 
      <span class="p">)</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">tagPhysical</span><span class="p">(</span> <span class="n">gm</span><span class="o">.</span><span class="n">getRegionByTag</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="n">iNum</span><span class="p">]</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="p">)</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshRegionByPhysical</span><span class="p">(</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addFace</span><span class="p">(</span>
        <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="n">iNum</span><span class="p">]</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;-&gt;NORTH&quot;</span><span class="p">),</span> <span class="mi">1</span> 
      <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Add &quot;WEST&quot; surface of first and &quot;EAST&quot; surface of last mesh block to</span>
    <span class="c1"># outer region; both surfaces are also coupling surfaces</span>
    <span class="c1">#</span>
    <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshRegionByPhysical</span><span class="p">(</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addFace</span><span class="p">(</span>
     <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span><span class="s2">&quot;xyz_meshBlock_0-&gt;WEST&quot;</span><span class="p">),</span> <span class="mi">1</span> 
    <span class="p">)</span>
    <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshRegionByPhysical</span><span class="p">(</span><span class="s2">&quot;xyz_channel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addFace</span><span class="p">(</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span>
        <span class="s2">&quot;xyz_meshBlock_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">mbIndices</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&gt;EAST&quot;</span>
      <span class="p">),</span> 
      <span class="mi">1</span> 
    <span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create an observer to automatically detect internal edges of the outer </span>
    <span class="c1"># region &quot;xyz_channel&quot;; the observer extracts all edges that lie within </span>
    <span class="c1"># the &quot;NORTH&quot; and &quot;SOUTH&quot; face of the region; the extracted edges are then</span>
    <span class="c1"># oriented to form an edge loop</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOAddInternalEdge</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span><span class="s1">&#39;{ &quot;_regionLabel&quot; : &quot;xyz_channel&quot;}&#39;</span><span class="p">),</span> 
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gBV</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Apply observer with the &quot;preUpdate&quot; function; in general, observers can</span>
    <span class="c1"># be applied before or after the meshing procedure; theoretically, the </span>
    <span class="c1"># observer can also be appended to the internal observer vector of the</span>
    <span class="c1"># bounded volume; if this is the case, all observers within the vector are</span>
    <span class="c1"># then automatically applied; in the case at hand, the observer is</span>
    <span class="c1"># manually applied</span>
    <span class="c1">#</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">preUpdate</span><span class="p">()</span>
   
    <span class="c1">#</span>
    <span class="c1"># Define number of elements within the mesh blocks; the regions are also</span>
    <span class="c1"># defined to be transfinite with a recursive recombination; the latter</span>
    <span class="c1"># enables the creation of quadrangles or rather hexahedrons</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">iNum</span> <span class="ow">in</span> <span class="n">mbIndices</span><span class="p">:</span>
      <span class="n">mb</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshRegionByPhysical</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">aG</span><span class="p">[</span><span class="n">iNum</span><span class="p">]</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="p">)</span>
      <span class="n">mb</span><span class="o">.</span><span class="n">meshWNElements</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
      <span class="n">mb</span><span class="o">.</span><span class="n">meshTransfiniteRecursive</span><span class="p">()</span>
      <span class="n">mb</span><span class="o">.</span><span class="n">meshRecombineRecursive</span><span class="p">()</span>
    
    <span class="c1">#</span>
    <span class="c1"># Define number of elements at periodic, inlet, and outlet surface; there</span>
    <span class="c1"># is only one element in x-direction, because it is a two dimensional</span>
    <span class="c1"># simulation; the surfaces are meshed transfinite and the mesh is then </span>
    <span class="c1"># recombined</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">lab</span><span class="p">,</span> <span class="n">nU</span><span class="p">,</span> <span class="n">nV</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
      <span class="p">[</span>
        <span class="s2">&quot;xyz_channel-&gt;EAST&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;xyz_channel-&gt;WEST&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;xyz_channel-&gt;FRONT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;xyz_channel-&gt;BACK&quot;</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,],</span>
      <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,]</span>
    <span class="p">):</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">meshWNElements</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">meshTransfinite</span><span class="p">()</span>
      <span class="n">gm</span><span class="o">.</span><span class="n">getDtGmshFaceByPhysical</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">meshRecombine</span><span class="p">()</span>
    
    <span class="c1">#</span>
    <span class="c1"># As mentioned above, the case is a two dimensional simulation; therefore,</span>
    <span class="c1"># the mesh is periodic on the &quot;NORTH&quot; and &quot;SOUTH&quot; face of the outer </span>
    <span class="c1"># region; the transformation between the nodes is a simple translation in</span>
    <span class="c1"># x-direction; it is implemented by using objects of translate</span>
    <span class="c1">#</span>
    <span class="n">dtT_hs</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span> 
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">()</span><span class="o">.</span><span class="n">appendDtVector3</span><span class="p">(</span><span class="s2">&quot;_v3&quot;</span><span class="p">,</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtVector3</span><span class="p">(</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">H_</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># The transformer is appended to a temporary baseContainer</span>
    <span class="c1"># </span>
    <span class="n">tmp_bC</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">baseContainer</span><span class="p">()</span>
    <span class="n">tmp_bC</span><span class="o">.</span><span class="n">ptrTransformerContainer</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dtT_hs</span><span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Create the observer to handle translational periodicity in gmsh; </span>
    <span class="c1"># customize the observer with a JSON object that sets master and slave </span>
    <span class="c1"># face and, additionally, provide the transformer</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOSetTranslationalPeriodicity</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span> 
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
        <span class="s1">&#39;{&#39;</span>
          <span class="s1">&#39;&quot;_faceMaster&quot; : &quot;xyz_channel-&gt;SOUTH&quot;,&#39;</span>
          <span class="s1">&#39;&quot;_faceSlave&quot; : &quot;xyz_channel-&gt;NORTH&quot;&#39;</span>
        <span class="s1">&#39;}&#39;</span>
      <span class="p">)</span><span class="o">.</span><span class="n">appendDtTransformer</span><span class="p">(</span><span class="s2">&quot;_dtT&quot;</span><span class="p">,</span> <span class="n">dtT_hs</span><span class="p">),</span> 
      <span class="n">tmp_bC</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gBV</span> 
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Apply transformer by calling &quot;preUpdate&quot; function</span>
    <span class="c1">#</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">preUpdate</span><span class="p">()</span>
   
    <span class="c1">#</span>
    <span class="c1"># Perform the meshing procedure within the &quot;bVOMeshRule&quot; observer; the</span>
    <span class="c1"># meshing procedure is customized within the JSON structure; there is a</span>
    <span class="c1"># rule for each mesh dimension; within a rule an operator is combined</span>
    <span class="c1"># with entities by their labels; the operators are then defined in the</span>
    <span class="c1"># &quot;dtMeshOperator&quot; vector</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOMeshRule</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span> 
        <span class="s1">&#39;{&#39;</span>
          <span class="s1">&#39;&quot;option&quot; : [&#39;</span>
            <span class="s1">&#39;{&quot;name&quot; : &quot;debug&quot;, &quot;value&quot; : &quot;true&quot;}&#39;</span>
          <span class="s1">&#39;],&#39;</span>
          <span class="s1">&#39;&quot;_rule1D&quot; : [&#39;</span>
            <span class="s1">&#39;&quot;dtMeshGEdge(xyz_channel-&gt;*-&gt;*)&quot;,&#39;</span>
            <span class="s1">&#39;&quot;dtMeshGEdge(xyz_meshBlock_*-&gt;*-&gt;*)&quot;&#39;</span>
          <span class="s1">&#39;],&#39;</span>
          <span class="s1">&#39;&quot;_rule2D&quot; : [&#39;</span>
            <span class="s1">&#39;&quot;dtMeshTransfiniteGFace(xyz_meshBlock*-&gt;*)&quot;,&#39;</span>
            <span class="s1">&#39;&quot;dtMeshGFace(xyz_*-&gt;*)&quot;&#39;</span>
          <span class="s1">&#39;],&#39;</span>
          <span class="s1">&#39;&quot;_rule3D&quot; : [&#39;</span>
            <span class="s1">&#39;&quot;dtMeshGRegion(xyz_meshBlock*)&quot;,&#39;</span>
            <span class="s1">&#39;&quot;dtMeshGRegionWithOneLayer(xyz_channel*)&quot;&#39;</span>
          <span class="s1">&#39;],&#39;</span>
          <span class="s1">&#39;&quot;_only&quot; : [],&#39;</span>
          <span class="s1">&#39;&quot;dtMeshOperator&quot; : [&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;dtMeshGEdge&quot;,&#39;</span>
              <span class="s1">&#39;&quot;label&quot; : &quot;dtMeshGEdge&quot;&#39;</span>
            <span class="s1">&#39;},&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;dtMeshGFace&quot;,&#39;</span>
              <span class="s1">&#39;&quot;label&quot; : &quot;dtMeshGFace&quot;&#39;</span>
            <span class="s1">&#39;},&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;dtMeshTransfiniteGFace&quot;,&#39;</span>
              <span class="s1">&#39;&quot;label&quot; : &quot;dtMeshTransfiniteGFace&quot;&#39;</span>
            <span class="s1">&#39;},&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;dtMeshGRegion&quot;,&#39;</span>
              <span class="s1">&#39;&quot;label&quot; : &quot;dtMeshGRegion&quot;,&#39;</span>
              <span class="s1">&#39;&quot;_minQShapeMetric&quot; : 0.0,&#39;</span> 
              <span class="s1">&#39;&quot;_relax&quot; : 0.1,&#39;</span>
              <span class="s1">&#39;&quot;_nPyramidOpenSteps&quot; : 10,&#39;</span>
              <span class="s1">&#39;&quot;_nSmooths&quot; : 3&#39;</span>
            <span class="s1">&#39;},&#39;</span>
            <span class="s1">&#39;{&#39;</span>
              <span class="s1">&#39;&quot;name&quot; : &quot;dtMeshGRegionWithOneLayer&quot;,&#39;</span>
              <span class="s1">&#39;&quot;label&quot; : &quot;dtMeshGRegionWithOneLayer&quot;,&#39;</span>
              <span class="s1">&#39;&quot;_faceMaster&quot; : &quot;xyz_channel-&gt;SOUTH&quot;,&#39;</span> 
              <span class="s1">&#39;&quot;_faceSlave&quot; : &quot;xyz_channel-&gt;NORTH&quot;&#39;</span>
            <span class="s1">&#39;}&#39;</span>
                        
          <span class="s1">&#39;]&#39;</span>
        <span class="s1">&#39;}&#39;</span>
      <span class="p">),</span>
      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gBV</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Attach the observer to the boundedVolume; this means that it is </span>
    <span class="c1"># automatically executed; it is necessary to set the thisown flag, </span>
    <span class="c1"># otherwise the objects is being destroyed</span>
    <span class="c1">#</span>
    <span class="n">gBV</span><span class="o">.</span><span class="n">attachBVObserver</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">thisown</span> <span class="o">=</span> <span class="kc">False</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create the mesh within the boundedVolume</span>
    <span class="c1">#</span>
    <span class="n">gBV</span><span class="o">.</span><span class="n">makeGrid</span><span class="p">()</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create an observer that renames internal mesh faces; this cleans up and </span>
    <span class="c1"># creates a clear naming of the faces</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOFaceToPatchRule</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span>
        <span class="s1">&#39;{&#39;</span>
          <span class="s1">&#39;&quot;_patchRule&quot; : [&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;FRONT::INLET:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;BACK::OUTLET:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;EAST::PERIOA:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;WEST::PERIOB:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_meshBlock_*-&gt;BACK::EMPTYB:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_meshBlock_*-&gt;FRONT::EMPTYA:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;SOUTH::EMPTYA:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_channel-&gt;NORTH::EMPTYB:&quot;,&#39;</span>
            <span class="s1">&#39;&quot;:xyz_meshBlock_*-&gt;SOUTH::BLADE:&quot;&#39;</span>
          <span class="s1">&#39;],&#39;</span>
          <span class="s1">&#39;&quot;_regRule&quot; : [&quot;:*::R:&quot;]&#39;</span>
        <span class="s1">&#39;}&#39;</span>
      <span class="p">),</span> <span class="n">gBV</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Apply the observer after the mesh is created; this is done by calling</span>
    <span class="c1"># &quot;postUpdate&quot;</span>
    <span class="c1">#</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">postUpdate</span><span class="p">()</span>
    
    <span class="c1">#</span>
    <span class="c1"># Create and apply an observer to write the mesh in the gmsh native &quot;msh&quot;</span>
    <span class="c1"># format to disk</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOWriteMSH</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span> <span class="s1">&#39;{&quot;_filename&quot; : &quot;&quot;, &quot;_saveAll&quot; : true}&#39;</span> <span class="p">),</span> <span class="n">gBV</span> 
    <span class="p">)</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">postUpdate</span><span class="p">()</span>
   
    <span class="c1">#</span>
    <span class="c1"># Create and apply an observer that orients the cell volumes within the</span>
    <span class="c1"># mesh; this makes sure to be conform with OpenFoam</span>
    <span class="c1">#</span>
    <span class="n">ob</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">bVOOrientCellVolumes</span><span class="p">()</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">jInit</span><span class="p">(</span>
      <span class="n">dtOO</span><span class="o">.</span><span class="n">jsonPrimitive</span><span class="p">(</span><span class="s1">&#39;{ &quot;_positive&quot; : true }&#39;</span><span class="p">),</span> <span class="n">gBV</span>
    <span class="p">)</span>
    <span class="n">ob</span><span class="o">.</span><span class="n">postUpdate</span><span class="p">()</span>
    
    <span class="c1">#</span>
    <span class="c1"># Calculate again the width of the channel for defining the periodic</span>
    <span class="c1"># surfaces</span>
    <span class="c1">#</span>
    <span class="n">twoPiRByNB</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span><span class="o">/</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">nB_</span>
    
    <span class="c1">#</span>
    <span class="c1"># Import a predefined builder to setup the OpenFoam case; within the </span>
    <span class="c1"># builder all necessary files are written to disk; it includes an</span>
    <span class="c1"># automatic definition of functions for calculating total pressure and</span>
    <span class="c1"># discharges on desired patches; additionally all boundary conditions are</span>
    <span class="c1"># defined</span>
    <span class="c1">#</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dtOOPythonApp.builder</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
      <span class="n">ofOpenFOAMCase_turboMachine</span><span class="p">,</span>
      <span class="n">ofOpenFOAMCase_setupWrapper</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">ofOpenFOAMCase_turboMachine</span><span class="p">(</span>
      <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span>
      <span class="n">bVs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bV</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">],</span>
      <span class="p">],</span>
      <span class="n">dictRule</span> <span class="o">=</span> 
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">controlDict</span><span class="p">(</span>
            <span class="n">application</span> <span class="o">=</span> <span class="s2">&quot;simpleFoam&quot;</span><span class="p">,</span>
            <span class="n">endTime</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">QPatches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INLET&#39;</span><span class="p">,</span><span class="s1">&#39;OUTLET&#39;</span><span class="p">,],</span>
            <span class="n">PTPatches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INLET&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTLET&#39;</span><span class="p">,],</span>
            <span class="n">FPatches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BLADE&#39;</span><span class="p">,],</span>
            <span class="n">libs</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="p">)</span>
        <span class="o">+</span> <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fvSchemes</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fvSolution</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">transportModel</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">turbulenceProperties</span><span class="p">(),</span>
        <span class="n">fieldRules</span> <span class="o">=</span> <span class="p">[</span> 
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fieldRuleString</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,]),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fieldRuleString</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,]),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fieldRuleString</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,]),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fieldRuleString</span><span class="p">(</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,]),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">fieldRuleString</span><span class="p">(</span><span class="s2">&quot;nut&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,]),</span>
        <span class="p">],</span>
        <span class="n">setupRules</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">emptyRuleString</span><span class="p">(),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">inletRuleString</span><span class="p">(</span>
            <span class="s2">&quot;INLET&quot;</span><span class="p">,</span> 
            <span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span> 
            <span class="p">[</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">n_</span><span class="o">/</span><span class="mf">60.</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">c_mi_</span><span class="p">],</span> <span class="p">]</span>
          <span class="p">),</span> 
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">inletRuleString</span><span class="p">(</span>
            <span class="s2">&quot;INLET&quot;</span><span class="p">,</span> 
            <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span><span class="p">,],</span> 
            <span class="p">[</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.032</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span> <span class="p">]</span>
          <span class="p">),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">emptyRuleString</span><span class="p">(</span>
            <span class="s2">&quot;EMPTYA&quot;</span>
          <span class="p">),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">emptyRuleString</span><span class="p">(</span>
            <span class="s2">&quot;EMPTYB&quot;</span> 
          <span class="p">),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">wallRuleString</span><span class="p">(</span>
            <span class="s2">&quot;BLADE&quot;</span><span class="p">,</span> 
            <span class="p">[</span><span class="s2">&quot;omega&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;nut&quot;</span><span class="p">]</span>
          <span class="p">),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">cyclicAmiTranslationalRuleString</span><span class="p">(</span>
            <span class="s2">&quot;PERIOA&quot;</span><span class="p">,</span> <span class="s2">&quot;PERIOB&quot;</span><span class="p">,</span> 
            <span class="n">sepVector</span> <span class="o">=</span> <span class="n">dtOO</span><span class="o">.</span><span class="n">dtVector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">twoPiRByNB</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
          <span class="p">),</span>
          <span class="n">ofOpenFOAMCase_setupWrapper</span><span class="o">.</span><span class="n">outletRuleString</span><span class="p">(</span>
            <span class="s2">&quot;OUTLET&quot;</span><span class="p">,</span> 
            <span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span><span class="p">,]</span>
          <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">buildExtract</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Output to log of the current state label</span>
    <span class="c1">#</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> 
      <span class="s2">&quot;Current state is &gt; </span><span class="si">%s</span><span class="s2"> &lt;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="p">()</span><span class="o">.</span><span class="n">commonState</span><span class="p">())</span> 
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Run the current state of the dtCase object &quot;of&quot;; this object was created</span>
    <span class="c1"># with the &quot;ofOpenFOAMCase_turboMachine&quot; builder</span>
    <span class="c1">#</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">[</span><span class="s2">&quot;of&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">runCurrentState</span><span class="p">()</span></div>


<div class="viewcode-block" id="hydFoil.Simulate">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.Simulate">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform the simulation.</span>

<span class="sd">    Perform the simulation using foamlib. The simulation runs for 500 </span>
<span class="sd">    iterations as a laminar simulation. Afterwards, it is switched to turbulent</span>
<span class="sd">    mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Create an FoamCase object of foamlib to control the simulation; the</span>
    <span class="c1"># &quot;getDirectory&quot; function returns the case directory that was created</span>
    <span class="c1">#</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">FoamCase</span><span class="p">(</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">[</span><span class="s2">&quot;of&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getDirectory</span><span class="p">(</span><span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="p">()</span><span class="o">.</span><span class="n">commonState</span><span class="p">())</span> 
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Turn off turbulence, modify the controlDict and run the simulation; this</span>
    <span class="c1"># is done twice</span>
    <span class="c1">#</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">turbulence_properties</span><span class="p">[</span><span class="s2">&quot;RAS&quot;</span><span class="p">][</span><span class="s2">&quot;turbulence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;endTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;writeInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">turbulence_properties</span><span class="p">[</span><span class="s2">&quot;RAS&quot;</span><span class="p">][</span><span class="s2">&quot;turbulence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;endTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;writeInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>


<div class="viewcode-block" id="hydFoil.FailedFitness">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.FailedFitness">[docs]</a>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">FailedFitness</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Failed fitness.</span>

<span class="sd">    Returns the value that represents a failed design.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">      Fitness for a failed design.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">hydFoil</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>    </div>


<div class="viewcode-block" id="hydFoil.Evaluate">
<a class="viewcode-back" href="../../../../demonstration.html#dtOO.demo.hydFoilOpt.build.hydFoil.Evaluate">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate the simulation.</span>

<span class="sd">    The simulation is evaluated using the pyDtOO library. Additionally, the</span>
<span class="sd">    &quot;patchToCsv&quot; application is used to create csv files of the boundaries.</span>

<span class="sd">    The fitness function is calculated based on head deviation and efficiency.</span>
<span class="sd">    Efficiency is given by the equation</span>

<span class="sd">    .. math::</span>
<span class="sd">      </span>
<span class="sd">      \\Delta \\eta = 1 - \\frac{F_y u}{\\rho g H Q}</span>

<span class="sd">    with :math:`F_y`, :math:`u`, :math:`\\rho`, :math:`g`, :math:`H`, </span>
<span class="sd">    and :math:`Q` that corresponds to force in :math:`y`-direction, rotational</span>
<span class="sd">    speed, density, gravitational constant, simulated head, and discharge. The </span>
<span class="sd">    deviation in head is calculated by</span>

<span class="sd">    .. math::</span>

<span class="sd">      \\Delta H = \\frac{|H-H_d|}{H_d}</span>

<span class="sd">    with :math:`H_d` that corresponds to design head. Then, the fitness value </span>
<span class="sd">    :math:`f` is defined as:</span>

<span class="sd">    .. math::</span>

<span class="sd">      f = \\Delta H + \\Delta \\eta \\mathrm{.}</span>

<span class="sd">    It is clear: the lower the fitness function :math:`f`, the better the</span>
<span class="sd">    candidate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float:</span>
<span class="sd">      Fitness value of this candidate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Get case directory of case</span>
    <span class="c1">#</span>
    <span class="n">cDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">[</span><span class="s2">&quot;of&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getDirectory</span><span class="p">(</span><span class="n">dtOO</span><span class="o">.</span><span class="n">lVHOstateHandler</span><span class="p">()</span><span class="o">.</span><span class="n">commonState</span><span class="p">())</span>
   
    <span class="c1">#</span>
    <span class="c1"># Run &quot;patchToCsv&quot; to extract the data on the boundary; this executable</span>
    <span class="c1"># writes csv files for each boundary</span>
    <span class="c1">#</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;patchToCsv&#39;</span><span class="p">,</span> <span class="s1">&#39;-latestTime&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;INLET&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cDir</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;patchToCsv&#39;</span><span class="p">,</span> <span class="s1">&#39;-latestTime&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTLET&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cDir</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;patchToCsv&#39;</span><span class="p">,</span> <span class="s1">&#39;-latestTime&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;INLET&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cDir</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;patchToCsv&#39;</span><span class="p">,</span> <span class="s1">&#39;-latestTime&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;OUTLET&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cDir</span><span class="p">)</span>
   
    <span class="c1">#</span>
    <span class="c1"># Read the output generated by OpenFoam in the postProcessing folder; the</span>
    <span class="c1"># class automatically provides functions for calculating the average of</span>
    <span class="c1"># the forces</span>
    <span class="c1">#</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtForceDeveloping</span><span class="p">(</span> 
      <span class="n">pd</span><span class="o">.</span><span class="n">dtDeveloping</span><span class="p">(</span><span class="n">cDir</span><span class="o">+</span><span class="s1">&#39;/postProcessing/F_BLADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;force.dat&#39;</span> <span class="p">:</span> <span class="s1">&#39;:,4:10&#39;</span><span class="p">,</span> <span class="s1">&#39;moment.dat&#39;</span> <span class="p">:</span> <span class="s1">&#39;:,4:10&#39;</span><span class="p">,</span> <span class="s1">&#39;*.*&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
      <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Get the average of the force in y-direction</span>
    <span class="c1">#</span>
    <span class="n">FMean</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ForceMeanLast</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># Initialize again an FoamCase object of foamlib</span>
    <span class="c1">#</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">FoamCase</span><span class="p">(</span><span class="n">cDir</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Get the last time directory</span>
    <span class="c1">#</span>
    <span class="n">tName</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="c1">#</span>
    <span class="c1"># Read velocities and pressures at the inlet and outlet of the last time </span>
    <span class="c1"># step; the class dtValueField provides functions to evaluate integral</span>
    <span class="c1"># values on the surfaces</span>
    <span class="c1">#</span>
    <span class="n">U_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtValueField</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtField</span><span class="p">(</span><span class="n">cDir</span><span class="o">+</span><span class="s1">&#39;/INLET_U_&#39;</span><span class="o">+</span><span class="n">tName</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">U_o</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtValueField</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtField</span><span class="p">(</span><span class="n">cDir</span><span class="o">+</span><span class="s1">&#39;/OUTLET_U_&#39;</span><span class="o">+</span><span class="n">tName</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">p_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtValueField</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtField</span><span class="p">(</span><span class="n">cDir</span><span class="o">+</span><span class="s1">&#39;/INLET_p_&#39;</span><span class="o">+</span><span class="n">tName</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">p_o</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtValueField</span><span class="p">(</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtField</span><span class="p">(</span><span class="n">cDir</span><span class="o">+</span><span class="s1">&#39;/OUTLET_p_&#39;</span><span class="o">+</span><span class="n">tName</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">()</span> <span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># Transform relative velocity &quot;w&quot; to absolute velocity &quot;c&quot; by subtracting</span>
    <span class="c1"># &quot;u&quot;</span>
    <span class="c1">#</span>
    <span class="n">U_i</span><span class="o">.</span><span class="n">value_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_i</span><span class="o">.</span><span class="n">value_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">n_</span><span class="o">/</span><span class="mf">60.</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span>
    <span class="n">U_o</span><span class="o">.</span><span class="n">value_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_o</span><span class="o">.</span><span class="n">value_</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">n_</span><span class="o">/</span><span class="mf">60.</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span>

    <span class="c1">#</span>
    <span class="c1"># Set constants density and gravitational acceleration</span>
    <span class="c1">#</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mf">997.0</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>

    <span class="c1">#</span>
    <span class="c1"># Integrate pressure and velocity over inlet and outlet; calculate the</span>
    <span class="c1"># sum of those energies to get the difference in head</span>
    <span class="c1">#</span>
    <span class="n">e_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_i</span><span class="o">.</span><span class="n">IntValueQ</span><span class="p">()</span> <span class="o">/</span> <span class="n">g</span> <span class="o">+</span> <span class="n">U_i</span><span class="o">.</span><span class="n">IntMagSquareQ</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">e_o</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_o</span><span class="o">.</span><span class="n">IntValueQ</span><span class="p">()</span> <span class="o">/</span> <span class="n">g</span> <span class="o">+</span> <span class="n">U_o</span><span class="o">.</span><span class="n">IntMagSquareQ</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">Q_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">U_i</span><span class="o">.</span><span class="n">IntQ</span><span class="p">())</span>
    <span class="n">dHMean</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_i</span> <span class="o">+</span> <span class="n">e_o</span><span class="p">)</span> <span class="o">/</span> <span class="n">Q_i</span>
   
    <span class="c1">#</span>
    <span class="c1"># Calculate efficiency of the blade</span>
    <span class="c1">#</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">FMean</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">n_</span><span class="o">/</span><span class="mf">60.</span><span class="o">*</span><span class="n">hydFoil</span><span class="o">.</span><span class="n">R_</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">dHMean</span><span class="o">*</span><span class="n">Q_i</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="c1"># Output to log file</span>
    <span class="c1">#</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> 
      <span class="s2">&quot;dH = (e_i + e_o) / Q_i =( </span><span class="si">%f</span><span class="s2"> + </span><span class="si">%f</span><span class="s2"> ) / </span><span class="si">%f</span><span class="s2"> = </span><span class="si">%f</span><span class="s2"> / F = </span><span class="si">%f</span><span class="s2">&quot;</span>
      <span class="o">%</span> 
      <span class="p">(</span><span class="n">e_i</span><span class="p">,</span> <span class="n">e_o</span><span class="p">,</span> <span class="n">Q_i</span><span class="p">,</span> <span class="n">dHMean</span><span class="p">,</span> <span class="n">FMean</span><span class="p">)</span> 
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;eta = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eta</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Calculate the fitness value as an averaged sum of design head deviation</span>
    <span class="c1"># and efficiency</span>
    <span class="c1">#</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dHMean</span> <span class="o">+</span> <span class="mf">0.8</span><span class="p">)</span><span class="o">/</span><span class="mf">0.8</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">eta</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Check if the simulated geometry is a pump or a turbine; if it is a pump,</span>
    <span class="c1"># return an artificial value that is greater than all other fitness values</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dHMean</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span> <span class="n">fit</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="c1">#hydFoil.FailedFitness()</span>

    <span class="c1">#</span>
    <span class="c1"># Initialize an object of dtClusteredSingletonState to have access to the</span>
    <span class="c1"># data base; update values of &quot;dH&quot;, &quot;F&quot; and fitness</span>
    <span class="c1">#</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">dtClusteredSingletonState</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_</span> <span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;dH&#39;</span><span class="p">,</span> <span class="n">dHMean</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">FMean</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;fitness&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Return fitness value</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">fit</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Alexander Tismer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>